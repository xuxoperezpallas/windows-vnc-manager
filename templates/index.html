<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Sesiones Windows</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Acceso a Windows VNC</h1>
        
        {% if error %}
            <div class="alert error">{{ error }}</div>
        {% endif %}
        
        {% if success %}
            <div class="alert success">{{ success }}</div>
        {% endif %}
        
        {% if session_url %}
            <div class="session-info">
                <h2>Sesión Activa</h2>
                <p>Accede a tu sesión Windows:</p>
                <a href="{{ session_url }}" target="_blank" class="btn-connect">{{ session_url }}</a>
                <p>Usuario: <strong>{{ username }}</strong></p>
            </div>
        {% endif %}
        
        <div class="card">
            <h2>Crear Nueva Sesión Windows</h2>
            <form action="/start-session" method="POST">
                <div class="form-group">
                    <label for="username">Nombre de usuario:</label>
                    <input type="text" id="username" name="username" placeholder="guest" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contraseña VNC:</label>
                    <input type="password" id="password" name="password" value="Passw0rd!" required>
                </div>
                
                <div class="form-group">
                    <label for="version">Versión de Windows:</label>
                    <select id="version" name="version" required>
                        {% for key, value in windows_versions.items() %}
                            <option value="{{ key }}">{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="btn-create">Iniciar Sesión</button>
            </form>
        </div>
        
        <div class="card">
            <h2>Sesiones Activas</h2>
            <div class="session-list" id="sessionList">
                <p>Cargando sesiones activas...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Función para cargar sesiones activas
        function loadSessions() {
            fetch('/list-sessions')
                .then(response => response.json())
                .then(sessions => {
                    if (sessions.length > 0) {
                        let html = '<table><thead><tr><th>Nombre</th><th>Usuario</th><th>Acción</th></tr></thead><tbody>';
                        
                        sessions.forEach(session => {
                            html += `
                                <tr>
                                    <td>${session.vm_name}</td>
                                    <td>${session.username}</td>
                                    <td>
                                        <a href="${session.url}" target="_blank" class="btn-connect">Conectar</a>
                                        <button class="btn-stop" data-vm="${session.vm_name}">Detener</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                        document.getElementById('sessionList').innerHTML = html;
                        
                        // Agregar event listeners a los botones
                        document.querySelectorAll('.btn-stop').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const vmName = this.getAttribute('data-vm');
                                stopSession(vmName);
                            });
                        });
                    } else {
                        document.getElementById('sessionList').innerHTML = '<p>No hay sesiones activas</p>';
                    }
                })
                .catch(error => {
                    console.error('Error cargando sesiones:', error);
                    document.getElementById('sessionList').innerHTML = '<p class="error">Error cargando sesiones</p>';
                });
        }
        
        // Función para detener sesión
        function stopSession(vmName) {
            if (confirm(`¿Estás seguro de que quieres detener la sesión ${vmName}?`)) {
                fetch(`/stop-session/${vmName}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Sesión ${vmName} detenida`);
                            loadSessions();
                        } else {
                            alert(`Error: ${data.message}`);
                        }
                    });
            }
        }
        
        // Cargar sesiones al iniciar y cada 30 segundos
        document.addEventListener('DOMContentLoaded', loadSessions);
        setInterval(loadSessions, 30000);
    </script>
</body>
</html>
